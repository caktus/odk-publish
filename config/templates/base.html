{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
        <script src="https://unpkg.com/htmx.org@2.0.2"
                integrity="sha384-Y7hw+L/jvKeWIRRkqWYfPcvVxHzVzn5REgzbawhxAuQGwX1XWe70vji+VSeHOThJ"
                crossorigin="anonymous"></script>
        <script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>
        <script defer
                src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
        <script>htmx.logAll()</script>
        <link href="{% static 'css/main.css' %}" rel="stylesheet" />
        {# favicon #}
        <link rel="shortcut icon"
              href="{% static 'favicon.ico' %}"
              type="image/x-icon" />
        <title>
            {% block title %}
                ODK Publish
            {% endblock title %}
        </title>
        {% block extra-css %}
        {% endblock extra-css %}
    </head>
    <body class="bg-white dark:bg-gray-900">
        {% include "includes/_navbar.html" %}
        {% block extra-nav %}
        {% endblock extra-nav %}
        <div class="{% if request.path == '/' %} mt-8 {% elif request.path != '/accounts/login/' %} w-full top-[25px] {% endif %} mb-20">
            {% if messages %}
                <div class="mx-auto max-w-screen-xl px-4 lg:px-12" id="messages">
                    {% for message in messages %}
                        {% if message.tags == 'info' or message.tags == 'success' %}
                            <div class="p-4 mb-4 text-sm text-blue-800 rounded-lg bg-brand-accent-light dark:bg-gray-800 dark:text-blue-400"
                                 role="alert">{{ message }}</div>
                        {% else %}
                            <div class="p-4 mb-4 text-sm text-brand-danger-medium rounded-lg bg-brand-danger-light dark:bg-gray-800 dark:text-brand-danger-light"
                                 role="alert">{{ message }}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
            {% block content %}
            {% endblock content %}
        </div>
        <script>
            document.body.addEventListener('htmx:configRequest', (event) => {
                event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
            })
            document.body.addEventListener("htmx:afterSwap", () => {
                window.initDropdowns();
                window.initModals();
                window.Flowbite.initDatepickers();
            })

            document.body.addEventListener("showAlertMessage", (e) => {
                let messages = document.querySelector("#messages")
                let successTypes = ["info", "success"];
                let successAlert = "text-blue-800 bg-blue-200 dark:text-blue-400";
                let errorAlert = "text-red-800 bg-red-200 dark:text-red-400";
                let msgColor = successTypes.includes(e.detail.type) ? successAlert : errorAlert;
                let message = `
                <div class="p-4 mb-4 text-sm rounded-lg dark:bg-gray-800 ${msgColor}" role="alert">${e.detail.message}</div>
                `
                messages.insertAdjacentHTML("beforeend", message)
            })

            // On page load or when changing themes, best to add inline in `head` to avoid FOUC
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark')
            }

            var themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            var themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

            // Change the icons inside the button based on previous settings
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                themeToggleLightIcon.classList.remove('hidden');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
            }

            var themeToggleBtn = document.getElementById('theme-toggle');

            themeToggleBtn.addEventListener('click', function() {

                // toggle icons inside button
                themeToggleDarkIcon.classList.toggle('hidden');
                themeToggleLightIcon.classList.toggle('hidden');

                // if set via local storage previously
                if (localStorage.getItem('color-theme')) {
                    if (localStorage.getItem('color-theme') === 'light') {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('color-theme', 'dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('color-theme', 'light');
                    }

                // if NOT set via local storage previously
                } else {
                    if (document.documentElement.classList.contains('dark')) {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('color-theme', 'light');
                    } else {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('color-theme', 'dark');
                    }
                }

            });
        </script>
    </body>
</html>
